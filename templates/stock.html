
# -------------------------------
# RUTA: CONSULTAR
# -------------------------------
@app.route("/consultar", methods=["GET", "POST"])
def consultar():
    categorias = Categoria.query.all()
    productos = []

    if request.method == "POST":
        nombre = request.form.get("nombre")
        categoria_id = request.form.get("categoria_id")

        query = Producto.query
        if nombre:
            query = query.filter(Producto.nombre.ilike(f"%{nombre}%"))
        if categoria_id:
            query = query.filter(Producto.categoria_id == categoria_id)

        productos = query.all()

    return render_template("consultar.html", categorias=categorias, productos=productos)

# -------------------------------
# RUTA: STOCK
# -------------------------------
@app.route("/stock")
def stock():
    productos = Producto.query.all()
    return render_template("stock.html", productos=productos)

# -------------------------------
# RUTA: EDITAR PRODUCTO
# -------------------------------
@app.route("/producto/editar/<int:id>", methods=["GET", "POST"])
def editar_producto(id):
    producto = Producto.query.get_or_404(id)
    categorias = Categoria.query.all()

    if request.method == "POST":
        producto.nombre = request.form["nombre"]
        producto.descripcion = request.form["descripcion"]
        producto.precio_compra = request.form["precio_compra"]
        producto.precio_venta = request.form["precio_venta"]
        producto.estado = request.form["estado"]
        producto.categoria_id = request.form.get("categoria_id") or None
        db.session.commit()
        return redirect(url_for("stock"))

    return render_template("editar_producto.html", producto=producto, categorias=categorias)

# -------------------------------
# RUTA: ELIMINAR PRODUCTO
# -------------------------------
@app.route("/producto/eliminar/<int:id>")
def eliminar_producto(id):
    producto = Producto.query.get_or_404(id)
    db.session.delete(producto)
    db.session.commit()
    return redirect(url_for("stock"))

if __name__ == "__main__":
    app.run(debug=True)